---
id: beckn
title: Enabling Beckn
sidebar_label: Enabling Beckn
---

## Introduction

This guide explains how to enable the Beckn protocol for commerce in your Pupilfirst instance.

## Design Decisions

- To enable Beckn for a course, set `beckn_enabled` to `true` in the school and course models.

### Request Specific Changes

Responses for each request are generated by `services` identifiable by their respective names, such as OnSelectDataService, OnSearchDataService, etc.

The response format follows the [DSEP Protocol Specification](https://github.com/beckn/DSEP-Specification/blob/draft/api/dsep.yaml). Example requests and responses are available in the [beckn-sandbox](https://github.com/beckn/beckn-sandbox/tree/main/src/dsep/courses-training/) repository.

Use the [swagger editor](https://editor.swagger.io/) to view the Beckn protocol API documentation.

#### Search

- Supports `provider` and `descriptor` filters, which correspond to `school` and `course name` respectively.
- If no filters are provided, the search will return all Beckn-enabled courses.

#### Confirm

- The student will be enrolled in the default cohort.
- A one-time login token will be generated and included in the response.

#### Update

- The update endpoint only supports updating the student name.

#### Cancel

- The cancel request will mark the student as `dropped_out`.

# Production Setup

## Prerequisites

Before enabling Beckn in your Pupilfirst instance, ensure you have:

- A Protocol Gateway that supports the Beckn protocol and its endpoints.
- A domain pointed at the LMS instance for receiving Beckn requests and `BECKN_DOMAIN` set in the environment (required only when multi-tenancy is enabled).
  > The Beckn webhook URL will be `https://<BECKN_DOMAIN>/inbound_webhooks/beckn`

## Environment Variables

Set the following environment variables:

```bash
# Domain configured for Beckn API.
BECKN_DOMAIN=your_beckn_webhook_domain

# Beckn Credentials
BECKN_BPP_ID=beckn_bpp_id
BECKN_BPP_URI=beckn_bpp_uri
BECKN_BPP_CLIENT_URI=beckn_bpp_client_uri
```

You will also need to set an email address for the school to comply with the protocol.

# Deployment Setup

Follow these steps to set up and run Beckn locally.

## Local Tunnel Setup

Use a tool like [localtunnel](https://github.com/localtunnel/localtunnel) to run a tunnel.

### Install tunnel globally

```bash
npm install -g localtunnel
```

### Run the tunnel

```bash
lt --port 6002 --subdomain=bpp-bodhi
```

You can change the subdomain as needed.

## Beckn Onix Protocol Server Setup

Ensure Docker is running on your machine.

Use beckn-onix to set up the protocol server. Refer to the [detailed docs](https://github.com/beckn/beckn-onix/blob/main/docs/setup_walkthrough.md#create-a-new-network-and-install-the-registry).

```bash
git clone https://github.com/beckn/beckn-onix.git
cd beckn-onix/install
./beckn-onix.sh
```

```
What would you like to do?: 1 (Join an existing network)
Which platform would you like to set up?: 3 (BPP)
Enter BPP Subscriber ID: bpp-bodhi-pf (This is the BECKN_BPP_ID, you can set it to any value)
Enter BPP Subscriber URL: https://bpp-bodhi.loca.lt (This is the BECKN_BPP_URI, you can set it to any value)
Enter the registry_url: https://registry.becknprotocol.io/subscribers
Enter Webhook URL: http://host.docker.internal:3000/inbound_webhooks/beckn (Make sure the port is same as the one you are running the server on)
```

> Linux users should use `172.17.0.1` instead of `host.docker.internal` in the webhook URL.

## Monitoring Protocol Server Logs

Monitor logs for the protocol server network and client in two terminal windows.

```bash
# Terminal 1
docker logs -f bpp-client
# Terminal 2
docker logs -f bpp-network
```

## Beckn Team Contact

Contact a Beckn team member with registry access to change the BPP state from initiated to subscribed. Reach out to `vbabu75` in the Beckn discord (use DSEP related channel / DM).

## Postman Collection Setup for Local Testing

Import samples from: [beckn-sandbox](https://github.com/beckn/beckn-sandbox/blob/main/artefacts/DSEP/dsep-services-sandbox.postman_collection.json)

Update the following variables in the collection:

```
bpp_uri: https://bpp-bodhi.loca.lt
bpp_id: bpp-bodhi-pf
```

## Layer2 Config Setup

When setting up beckn-onix, create a layer2 config in the network and client. The file name should correspond to the domain you are using.

Examples:

- For the domain `dsep:courses`, the file name should be `dsep_courses_1.1.0.yaml`. The version number should match the core schema version.
- For the domain `open-belem:courses`, the file name should be `open-belem_courses_1.1.0.yaml`.

```
# Create layer2 config in network
docker exec -it bpp-network sh
cd cd schemas/
cp core_1.1.0.yaml dsep_courses_1.1.0.yaml
```

```
# Create layer2 config in client
docker exec -it bpp-client sh
cd cd schemas/
cp core_1.1.0.yaml dsep_courses_1.1.0.yaml
```

## Pupilfirst Environment Variables Setup

```bash
BECKN_DOMAIN=beckn.localhost

# Beckn Credentials
BECKN_BPP_ID=bpp-bodhi-pf
BECKN_BPP_URI=https://bpp-bodhi.loca.lt
BECKN_BPP_CLIENT_URI=http://localhost:6001
```

## Server Start

Ensure the server is running on the same port as the one set in the webhook URL.

Requests will be sent to the server on the `/inbound_webhooks/beckn` endpoint, handled by the `InboundWebhooks::BecknController`. All requests through the Beckn protocol will be asynchronous and handled by the `InboundWebhooks::ProcessBecknRequestJob`.

## Common Issues

### Cache on the Registry

It may take some time for the registry to update the BPP state from initiated to subscribed. If you do not receive a request for `on_search`, try another request like `on_init` or `on_select`.

### Invalid Credentials

If setting up beckn-onix for the first time, the setup might fail to add `==` to the end of the credentials. The private key should end with `==` and the public key with `=`.

> Logs might show `Error: invalid input`. This issue has been observed on macOS but may occur on other OS as well.

```bash
# Enter the container
docker exec -it bpp-client sh
vi config/default.yml
# Update the keys by adding `==` to the end of the private key and `=` to the end of the public key.
# In VI, press `i` to enter insert mode, `esc` to exit insert mode, and `:wq` to save and exit.
# Restart the container
docker restart bpp-client
# Repeat the same for bpp-network
docker exec -it bpp-network sh
....
```
